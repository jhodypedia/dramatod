<div class="video-container">
  <video id="player" class="video-js vjs-big-play-centered" controls playsinline></video>
</div>

<% if (settings.adsenseCode) { %>
  <div class="adsense" style="margin:15px 0;">
    <%- settings.adsenseCode %>
  </div>
<% } %>

<div class="quality-select">
  <label>Kualitas:</label>
  <select id="quality" onchange="reloadQuality(this.value)">
    <option value="1080">1080p</option>
    <option value="720" selected>720p</option>
    <option value="480">480p</option>
  </select>
</div>

<div class="row">
  <h2>Pilih Episode</h2>
  <div id="episode-scroll" class="scroll"></div>
  <button id="loadMoreEp" class="btn">Load More</button>
</div>

<link href="https://cdn.jsdelivr.net/npm/video.js@8/dist/video-js.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/video.js@8/dist/video.min.js"></script>

<script>
  const bookId = "<%= bookId %>";
  let currentIndex = <%= index %>;
  let player;
  let currentQuality = 720;
  let pageEp = 1;

  function initPlayer(url) {
    if (player) player.dispose();
    player = videojs("player", { fluid: true, autoplay: true, preload: "auto" });
    player.src({ src: url, type: "application/x-mpegURL" });
  }

  async function loadEpisode(i) {
    const res = await fetch(`/api/chapters/${bookId}?page=${Math.ceil(i/20)}`);
    const data = await res.json();
    const ep = data.list.find(e => (e.index || e.chapterIndex) === i);
    if (!ep) return;

    const video = ep.cdnList?.[0]?.videoPathList?.find(v => v.quality == currentQuality) 
               || ep.cdnList?.[0]?.videoPathList?.[0];
    if (video) {
      currentIndex = i;
      initPlayer(video.videoPath);
      history.replaceState({}, "", `/watch/${bookId}/${i}`);
    }
  }

  function reloadQuality(q) {
    currentQuality = parseInt(q);
    loadEpisode(currentIndex);
  }

  async function loadEpisodeList() {
    const res = await fetch(`/api/chapters/${bookId}?page=${pageEp}`);
    const data = await res.json();
    const list = data.list || [];
    const container = document.getElementById("episode-scroll");

    list.forEach(ch => {
      const epIndex = ch.index || ch.chapterIndex || 0;
      const cover = ch.cover || ch.coverImg || ch.hCover || ch.hSmallCover || ch.verticalCover || ch.coverWap || '';
      const div = document.createElement("div");
      div.className = `card ${epIndex === currentIndex ? 'active' : ''}`;
      div.onclick = () => loadEpisode(epIndex);
      div.innerHTML = `
        <img src="/img?url=${encodeURIComponent(cover)}" class="lazy blur" alt="ep"/>
        <div class="ep-badge">Ep ${epIndex}</div>
      `;
      container.appendChild(div);
    });

    if (!list.length) document.getElementById("loadMoreEp").style.display = "none";
    pageEp++;
  }

  document.getElementById("loadMoreEp").addEventListener("click", loadEpisodeList);
  loadEpisodeList();
  loadEpisode(currentIndex);
</script>

<style>
  .quality-select { margin: 10px 0; }
  .card.active { outline: 2px solid #e50914; }
  .ep-badge { background: rgba(0,0,0,.6); color:#fff; text-align:center; font-size:12px; }
</style>
